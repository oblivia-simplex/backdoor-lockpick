#include <stdio.h>
#include <string.h>
#include <openssl/err.h>
#include <openssl/bn.h>
#include <openssl/rsa.h>

/***
 *
 * Expected test case
 *
=====
j%lJ$j%A[DGQ-v|p,-;Tr"
-----
	0xdd	0x02	0x0a	0x44	0x45	0x84	0xbd	0xf4
	0x86	0x8f	0x32	0xa3	0xad	0xbf	0x25	0x06
	0x5b	0x5a	0x75	0x9c	0x06	0xb1	0xad	0xf5
	0xb1	0x41	0x0e	0xaa	0xcc	0x61	0xcc	0x01
	0xfd	0x59	0xb8	0xbd	0x7b	0x19	0x17	0x78
	0xa2	0x77	0xac	0xae	0x40	0x43	0x5a	0xa8
	0x25	0x78	0xda	0x6c	0xae	0x93	0x56	0xb7
	0xc2	0x47	0x14	0x1b	0xb0	0xef	0x70	0xc3
	0x95	0x27	0x3d	0x3c	0xde	0x3c	0x34	0x21
	0xf4	0xc7	0xef	0xf0	0xa0	0x7a	0xff	0xf4
	0x66	0x5f	0xdf	0x19	0x57	0x5e	0xe5	0x92
	0x2b	0x16	0xa8	0x17	0x21	0xe6	0xc6	0x30
	0x7e	0x60	0x9a	0xdd	0x04	0xda	0xe5	0xe2
	0x63	0xff	0x2f	0x12	0x0c	0xa2	0x6f	0x6e
	0x6a	0x27	0x9c	0xa9	0x4a	0x3e	0x01	0x5f
	0x19	0x60	0xfc	0x1e	0x7d	0xc4	0x94	0xf7
*/



RSA *init_rsa() {
  BIGNUM *e;
  BIGNUM *n;
  RSA *rsa;
  rsa = RSA_new();
  n = BN_new();
  e = BN_new();
  BN_set_word(e,0x10001);
  BN_hex2bn(&n, "E541A631680C453DF31591A6E29382BC5EAC969DCFDBBCEA64CB49CBE36578845C507BF5E7A6BCD724AFA7063CA754826E8D13DBA18A2359EB54B5BE3368158824EA316A495DDC3059C478B41ABF6B388451D38F3C6650CDB4590C1208B91F688D0393241898C1F05A6D500C7066298C6BA2EF310F6DB2E7AF52829E9F858691");
  rsa->e = e;
  rsa->n = n;
}

int encrypt(RSA *rsa, char *plaintext, char *ciphertext) {
  int rsa_size;
  memset(ciphertext,0,0x80);
  rsa_size = RSA_size(rsa);
  return RSA_public_encrypt(rsa_size, plaintext, ciphertext, rsa, RSA_NO_PADDING); 
}


void print_ciphertext(unsigned char *ciphertext, int len) {
  int i;
  for (i = 0; i < len; i++) {
    if (i % 16 == 0) {
      printf("\n");
    } else if (i % 8 == 0) {
      printf("  ");
    } else {
      printf(" ");
    }
    printf("%02x", ciphertext[i]);
  }
  printf("\n");
}


int test() {
  unsigned char ciphertext[0x80];
  char test_case[32] = "S<:2\\fPve:j%lJ$j%A[DGQ-v|p,-;Tr";
  int res;
  RSA *rsa;
  rsa = init_rsa();

  unsigned char expected[0x80] = {
	0xdd,	0x02,	0x0a,	0x44,	0x45,	0x84,	0xbd,	0xf4,
	0x86,	0x8f,	0x32,	0xa3,	0xad,	0xbf,	0x25,	0x06,
	0x5b,	0x5a,	0x75,	0x9c,	0x06,	0xb1,	0xad,	0xf5,
	0xb1,	0x41,	0x0e,	0xaa,	0xcc,	0x61,	0xcc,	0x01,
	0xfd,	0x59,	0xb8,	0xbd,	0x7b,	0x19,	0x17,	0x78,
	0xa2,	0x77,	0xac,	0xae,	0x40,	0x43,	0x5a,	0xa8,
	0x25,	0x78,	0xda,	0x6c,	0xae,	0x93,	0x56,	0xb7,
	0xc2,	0x47,	0x14,	0x1b,	0xb0,	0xef,	0x70,	0xc3,
	0x95,	0x27,	0x3d,	0x3c,	0xde,	0x3c,	0x34,	0x21,
	0xf4,	0xc7,	0xef,	0xf0,	0xa0,	0x7a,	0xff,	0xf4,
	0x66,	0x5f,	0xdf,	0x19,	0x57,	0x5e,	0xe5,	0x92,
	0x2b,	0x16,	0xa8,	0x17,	0x21,	0xe6,	0xc6,	0x30,
	0x7e,	0x60,	0x9a,	0xdd,	0x04,	0xda,	0xe5,	0xe2,
	0x63,	0xff,	0x2f,	0x12,	0x0c,	0xa2,	0x6f,	0x6e,
	0x6a,	0x27,	0x9c,	0xa9,	0x4a,	0x3e,	0x01,	0x5f,
	0x19,	0x60,	0xfc,	0x1e,	0x7d,	0xc4,	0x94,	0xf7
  };

  printf("[=] Test case: '%s'\n", test_case);
  encrypt(rsa, test_case, ciphertext);

  res = memcmp(ciphertext, expected, 0x80);
  if (res != 0) {
    printf("[X] FAILED TEST CASE!\n");
    exit(1);
  }
  print_ciphertext(ciphertext, 0x80);

  printf("\n[*] TEST SUCCESSFUL!\n");

  return res;
}


int main(int argc, char **argv) {
  unsigned char ciphertext[0x80];
  char plaintext[32];
  int res;
  RSA *rsa;
  
  if (argc > 1 && !(strcmp(argv[1], "test"))) {
    test();
    exit(0);
  }

  rsa = init_rsa();

  printf("[+] Let's try a chosen plaintext attack. Padding mode = %d.\n", RSA_NO_PADDING);

  printf("[-] Trying null buffer...\n");
  memset(plaintext, 0, 32);
  encrypt(rsa, plaintext, ciphertext);
  print_ciphertext(ciphertext, 0x80);

  printf("[-] Flipping first bit of first byte...\n");
  plaintext[0] ^= 1;
  encrypt(rsa, plaintext, ciphertext);
  print_ciphertext(ciphertext, 0x80);

  return 0;
}
